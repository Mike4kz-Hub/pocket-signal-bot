import time
import pytz
import datetime
from tradingview_ta import TA_Handler, Interval, Exchange
from telegram import Bot

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù…
TELEGRAM_TOKEN = '8135952243:AAGJmti0ZQdVeDRN-f8Cd3eR_WFfoUdHtiU'
CHANNEL_USERNAME = '@signals_w_mike'

# Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
REFERRAL_LINK = 'https://po-ru4.click/login?utm_campaign=822955&utm_source=affiliate&utm_medium=sr&a=rxU4hmgPSO9y7Z&ac=mike4trader'

# Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ ÙŠÙ„ÙŠ Ø¨Ù†Ø´ØªØºÙ„ Ø¹Ù„ÙŠÙ‡Ø§ (Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ Ø£Ùˆ ØªØ¹Ø¯Ù„)
CURRENCY_PAIRS = [
    'EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD', 'USDCAD', 'USDCHF',
    'EURGBP', 'EURJPY', 'AUDCAD', 'AUDCHF', 'CADCHF', 'CADJPY',
    'EURAUD', 'EURNZD', 'CHFJPY', 'NZDUSD'
]

# ØªÙ‡ÙŠØ¦Ø© Ø¨ÙˆØª Ø§Ù„ØªÙŠÙ„ÙŠØºØ±Ø§Ù…
bot = Bot(token=TELEGRAM_TOKEN)

# UTC-3 timezone
tz = pytz.timezone('America/Sao_Paulo')

def analyze_signal(pair):
    handler = TA_Handler(
        symbol=pair,
        screener="forex",
        exchange="FX_IDC",
        interval=Interval.INTERVAL_1_MINUTE
    )
    try:
        analysis = handler.get_analysis()
        ema_50 = analysis.indicators.get("EMA50")
        ema_200 = analysis.indicators.get("EMA200")
        stochastic_k = analysis.indicators.get("Stoch.K")
        stochastic_d = analysis.indicators.get("Stoch.D")
        rsi = analysis.indicators.get("RSI")

        price = analysis.indicators.get("close")

        # Ø´Ø±ÙˆØ· CALL
        if price > ema_200 and price <= ema_50 and stochastic_k < 20 and stochastic_d < 20 and stochastic_k > stochastic_d:
            return "CALL"
        
        # Ø´Ø±ÙˆØ· PUT
        elif price < ema_200 and price >= ema_50 and stochastic_k > 80 and stochastic_d > 80 and stochastic_k < stochastic_d:
            return "PUT"

    except Exception as e:
        print(f"[{pair}] ØªØ­Ù„ÙŠÙ„ ÙØ´Ù„: {e}")
    
    return None

def send_signal(pair, direction):
    now = datetime.datetime.now(tz)
    time_str = now.strftime('%H:%M')

    message = f"""
ðŸ’°: {pair.replace('/', '')}
â±ï¸: 1M
ðŸ“Š: {direction}
â³: {time_str} UTC-3
ðŸ”—: {REFERRAL_LINK}
""".strip()

    bot.send_message(chat_id=CHANNEL_USERNAME, text=message)
    print(f"ðŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø©: {pair} â†’ {direction}")

def main():
    print("ðŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„...")
    while True:
        try:
            current_time = datetime.datetime.now(tz)
            if current_time.minute % 5 == 0 and current_time.second < 10:
                for pair in CURRENCY_PAIRS:
                    direction = analyze_signal(pair)
                    if direction:
                        send_signal(pair, direction)
                    else:
                        print(f"ðŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù€ {pair}")
                print("â³ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ...\n")
                time.sleep(300)  # Ø§Ù†ØªØ¸Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
            else:
                time.sleep(5)
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: {e}")
            time.sleep(10)

if name == "__main__":
    main()